--source include/have_innodb.inc
--source include/have_debug_sync.inc

CREATE TABLE t(a INT PRIMARY KEY) ENGINE=InnoDB;
INSERT INTO t VALUES(1);
BEGIN;
SELECT * FROM t FOR UPDATE;

connect (con1, localhost, root,,);
BEGIN;
# infinite timeout
SET innodb_lock_wait_timeout=100000000;
let $ID= `SELECT @id := CONNECTION_ID()`;
SET DEBUG_SYNC='lock_rec SIGNAL locking WAIT_FOR proceed';
send SELECT * FROM t FOR UPDATE;

connection default;
let $ignore= `SELECT @id := $ID`;

SET DEBUG_SYNC='now WAIT_FOR locking';
KILL QUERY @id;
SET DEBUG_SYNC='now SIGNAL proceed';

connection con1;
--error ER_QUERY_INTERRUPTED
reap;
disconnect con1;

connection default;
SET DEBUG_SYNC=RESET;

COMMIT;
DROP TABLE t;
