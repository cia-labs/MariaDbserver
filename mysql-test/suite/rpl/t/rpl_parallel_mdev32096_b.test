--source include/have_innodb.inc
--source include/have_binlog_format_row.inc
--source include/master-slave.inc

--connection slave
--source include/stop_slave.inc
SET @old_parallel= @@GLOBAL.slave_parallel_threads;
SET GLOBAL slave_parallel_threads= 3;
SET @old_mode= @@GLOBAL.slave_parallel_mode;
SET GLOBAL slave_parallel_mode= optimistic;
SET @old_timeout= @@GLOBAL.innodb_lock_wait_timeout;
SET GLOBAL innodb_lock_wait_timeout=10;
--source include/start_slave.inc

--connection master

ALTER TABLE mysql.gtid_slave_pos ENGINE=InnoDB;
CREATE TABLE t1 (a INT PRIMARY KEY, b INT) ENGINE=InnoDB;
INSERT INTO t1 VALUES (1, 0), (2, 0), (3, 0), (4, 0), (5, 0), (6, 0), (7, 0), (8, 0), (9, 0), (10, 0);

--sync_slave_with_master
--source include/stop_slave.inc
SET @old_dbug= @@GLOBAL.debug_dbug;
SET GLOBAL debug_dbug="+d,inject_mdev32096";

--connection master
# T1
SET SESSION gtid_seq_no= 100;
UPDATE t1 SET b=1 WHERE a=1;

# T2
SET SESSION gtid_seq_no= 101;
BEGIN;
UPDATE t1 SET b=2 WHERE a=6;
UPDATE t1 SET b=2 WHERE a=7;
#UPDATE t1 SET b=2 WHERE a=8;
#UPDATE t1 SET b=2 WHERE a=9;
#UPDATE t1 SET b=2 WHERE a=10;
COMMIT;

# T3
SET SESSION gtid_seq_no= 102;
BEGIN;
UPDATE t1 SET b=3 WHERE a=1;
UPDATE t1 SET b=3 WHERE a=2;
UPDATE t1 SET b=3 WHERE a=3;
UPDATE t1 SET b=3 WHERE a=4;
UPDATE t1 SET b=3 WHERE a=5;
UPDATE t1 SET b=3 WHERE a=6;
UPDATE t1 SET b=3 WHERE a=7;
UPDATE t1 SET b=3 WHERE a=8;
UPDATE t1 SET b=3 WHERE a=9;
UPDATE t1 SET b=3 WHERE a=10;
COMMIT;

SELECT * FROM t1 ORDER BY a;

--save_master_pos

--connection slave
--source include/start_slave.inc
--sync_with_master

SET GLOBAL debug_dbug=@old_dbug;
SELECT * FROM t1 ORDER BY a;

# Cleanup.

--connection slave
--source include/stop_slave.inc
SET GLOBAL slave_parallel_mode= @old_mode;
SET GLOBAL slave_parallel_threads= @old_parallel;
SET GLOBAL innodb_lock_wait_timeout= @old_timeout;
--source include/start_slave.inc

--connection master
DROP TABLE t1;
--source include/rpl_end.inc

